<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Successful - Well Clean</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="img/favicon-32x32.png" />

    <style>
      @media print {
        a.btn,
        .btn-download {
          display: none !important;
        }
      }

      body {
        background-color: #f8f9fa;
        font-family: "Varela Round", sans-serif;
      }
      .success-container {
        border: 1px solid #011e3b;
        max-width: 800px;
        margin: 50px auto;
        padding: 30px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }
      .success-icon {
        font-size: 60px;
        color: #28a745;
        margin-bottom: 20px;
        text-align: center;
      }
      .btn-whatsapp {
        background-color: #25d366;
        color: white;
        padding: 12px 25px;
        border-radius: 30px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        margin: 10px 5px;
        transition: all 0.3s;
        border: none;
      }
      .btn-whatsapp:hover {
        background-color: #128c7e;
        color: white;
        transform: translateY(-2px);
      }
      .btn-back {
        background-color: #6c757d;
        color: white;
        padding: 12px 25px;
        border-radius: 30px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        margin: 10px 5px;
        transition: all 0.3s;
      }
      .btn-back:hover {
        background-color: #5a6268;
        color: white;
        transform: translateY(-2px);
      }
      .btn-download {
        background-color: #0d6efd;
        color: white;
        padding: 12px 25px;
        border-radius: 30px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        margin: 10px 5px;
        transition: all 0.3s;
        border: none;
      }
      .btn-download:hover {
        background-color: #0b5ed7;
        color: white;
        transform: translateY(-2px);
      }
      .btn-download i {
        margin-right: 8px;
      }
      .booking-details {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 30px 0;
      }
      .detail-item {
        display: flex;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .detail-label {
        font-weight: 600;
        width: 200px;
        color: #495057;
      }
      .detail-value {
        flex: 1;
        color: #212529;
      }
      .payment-confirmed {
        font-size: 1.1em;
        font-weight: 600;
        color: #28a745;
        margin: 20px 0;
        text-align: center;
        padding: 10px;
        background-color: #e8f5e9;
        border-radius: 5px;
      }

      .capturing {
        opacity: 0.5;
      }
      #receiptContainer {
        position: fixed;
        left: -9999px;
        top: -9999px;
        width: 800px;
        background: white;
        padding: 40px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }
      .receipt-buttons {
        display: none !important;
      }
      .section-header {
        font-weight: bold;
        font-size: 1.1em;
        color: #2c3e50;
        margin-top: 20px;
        padding-bottom: 5px;
        border-bottom: 2px solid #3498db;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .detail-item {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
      }
      .detail-label {
        font-weight: 600;
        color: #555;
        margin-bottom: 4px;
      }
      .detail-value {
        color: #2c3e50;
      }
      .full-width {
        grid-column: 1 / -1;
      }
      .booking-details-container {
        padding: 20px;
        border-radius: 10px;
        background-color: #f8f9fa;
      }

      @media (max-width: 576px) {
        .success-container .detail-item {
          display: flex !important;
          flex-direction: row !important;
        }

        .section-header {
          font-size: 16px !important;
        }

        .detail-feilds {
          display: flex !important;
          flex-direction: column !important;
        }

        .detail-feilds-row {
          display: flex !important;
          flex-direction: row !important;
        }

        .detail-value {
          font-size: 14px !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Hidden receipt container -->
    <div id="receiptContainer"></div>

    <div class="container">
      <div class="success-container">
        <div class="text-center mb-4">
          <div class="d-flex justify-content-center align-items-center mb-3">
            <img src="img/testing-logo-23.webp" alt="Well Clean Logo"
            class="img-fluid me-3" style="max-height: 70px; margin-top: -14px;""
            />
          </div>
          <div class="d-flex justify-content-center">
            <h2 class="mb-3 d-flex align-items-center gap-2">
              Payment Successful!
              <div class="success-icon" style="font-size: 40px; margin: 0">
                <i class="fas fa-check-circle"></i>
              </div>
            </h2>
          </div>

          <p class="lead">Thank you for booking with Well Clean.</p>
        </div>
        <div class="payment-confirmed">
          <i class="fas fa-check-circle me-2"></i> Payment Confirmed
        </div>

        <div class="booking-details-container">
          <div id="bookingDetails">
            <!-- Details will be populated by JavaScript -->
          </div>
        </div>

        <div class="text-center">
          <p class="mb-4">
            Our team will contact you shortly to confirm your cleaning
            appointment details. <br />
            For any questions, feel free to reach out to us on WhatsApp.
          </p>

          <div class="d-flex justify-content-center flex-wrap">
            <a href="/" class="btn-back">
              <i class="fas fa-home me-2"></i>Back to Home
            </a>
            <a href="#" target="_blank" id="whatsappBtn" class="btn-whatsapp">
              <i class="fab fa-whatsapp me-2"></i>Chat on WhatsApp
            </a>
            <a href="#" id="downloadBtn" class="btn-download">
              <i class="fas fa-download me-2"></i>Download Receipt
            </a>
          </div>
        </div>
      </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        /** Utilities **/
        const urlParams = new URLSearchParams(window.location.search);
        const getParam = (name) => urlParams.get(name) || "";

        /** 1️⃣ Collect ALL booking data from query string **/
        // First, collect all form data from URL parameters
        const formData = {};
        urlParams.forEach((value, key) => {
          if (key.startsWith("form_")) {
            formData[key.replace("form_", "")] = value;
          }
        });

        // Determine which form was used
        const isBasicForm = formData.basicfullName !== undefined;
        const isDeepForm = formData.deepfullName !== undefined;

        // Set up booking details with appropriate values based on form type
        const bookingDetails = {
          // Common fields
          serviceType:
            urlParams.get("serviceType") || formData.serviceType || "N/A",
          cleaningType: urlParams.get("cleaningType") || "N/A",
          houseSize: urlParams.get("houseSize") || "N/A",
          priceRange: urlParams.get("priceRange") || "N/A",
          paymentStatus: urlParams.get("paymentStatus") || "Paid",
          paymentMethod: urlParams.get("paymentMethod") || "PayPal",

          // One-off form fields
          preferredDate: urlParams.get("oneOffDate") || "N/A",
          preferredTime: urlParams.get("oneOffTime") || "N/A",
          fullName: urlParams.get("customerName") || "N/A",
          email: urlParams.get("customerEmail") || "N/A",
          phone: urlParams.get("customerPhone") || "N/A",
          alternatePhone: urlParams.get("alternatePhone") || "N/A",
          address: urlParams.get("address") || "N/A",
          city: urlParams.get("city") || "N/A",
          postcode: urlParams.get("postcode") || "N/A",
          country: urlParams.get("country") || "N/A",
          notes: urlParams.get("regularNotes") || "N/A",

          // Form type flag
          formType: isBasicForm ? "basic" : isDeepForm ? "deep" : "oneoff",
        };

        // Override with basic form data if that's what was used
        if (isBasicForm) {
          bookingDetails.fullName =
            formData.basicfullName || bookingDetails.fullName;
          bookingDetails.email = formData.basicemail || bookingDetails.email;
          bookingDetails.phone = formData.basicphone || bookingDetails.phone;
          bookingDetails.alternatePhone =
            formData.basicaltPhone || bookingDetails.alternatePhone;
          bookingDetails.address =
            formData.basicaddress || bookingDetails.address;
          bookingDetails.city = formData.basiccity || bookingDetails.city;
          bookingDetails.postcode =
            formData.basicpostcode || bookingDetails.postcode;
          bookingDetails.country =
            formData.basiccountry || bookingDetails.country;
          bookingDetails.notes =
            formData.basicinstructions || bookingDetails.notes;
          bookingDetails.preferredDate =
            formData.basicpreferredDate || bookingDetails.preferredDate;
          bookingDetails.preferredTime =
            formData.basicpreferredTime || bookingDetails.preferredTime;
          bookingDetails.bedrooms = formData.basicbedrooms || "N/A";
          bookingDetails.frequency = formData.basicfrequency || "N/A";
        }
        // Override with deep form data if that's what was used
        else if (isDeepForm) {
          bookingDetails.fullName =
            formData.deepfullName || bookingDetails.fullName;
          bookingDetails.email = formData.deepemail || bookingDetails.email;
          bookingDetails.phone = formData.deepphone || bookingDetails.phone;
          bookingDetails.alternatePhone =
            formData.deepaltPhone || bookingDetails.alternatePhone;
          bookingDetails.address =
            formData.deepaddress || bookingDetails.address;
          bookingDetails.city = formData.deepcity || bookingDetails.city;
          bookingDetails.postcode =
            formData.deeppostcode || bookingDetails.postcode;
          bookingDetails.country =
            formData.deepcountry || bookingDetails.country;
          bookingDetails.notes =
            formData.deepinstructions || bookingDetails.notes;
          bookingDetails.preferredDate =
            formData.deeppreferredDate || bookingDetails.preferredDate;
          bookingDetails.preferredTime =
            formData.deeppreferredTime || bookingDetails.preferredTime;
          bookingDetails.bedrooms = formData.deepbedrooms || "N/A";
          bookingDetails.frequency = formData.deepfrequency || "N/A";
        }

        /** 2️⃣ Format date nicely **/
        const formatDate = (dateString) => {
          if (!dateString || dateString === "N/A") return "N/A";
          const d = new Date(dateString);
          return isNaN(d)
            ? dateString
            : d.toLocaleDateString("en-GB", {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
              });
        };

        /** 2.5 Format frequency nicely **/
        const formatFrequency = (freq) => {
          if (!freq || freq === "N/A") return "N/A";
          const freqMap = {
            weekly: "Weekly",
            biweekly: "Bi-weekly",
            monthly: "Monthly",
          };
          return freqMap[freq] || freq;
        };

        /** 3️⃣ Format time nicely **/
        const formatTime = (timeString) => {
          if (!timeString || timeString === "N/A") return "N/A";
          const match = timeString.match(/^(\d{1,2}):?(\d{2})?$/);
          if (!match) return timeString;
          let hours = parseInt(match[1], 10);
          const minutes = match[2] ? ":" + match[2] : ":00";
          const ampm = hours >= 12 ? "PM" : "AM";
          hours = hours % 12 || 12;
          return `${hours}${minutes} ${ampm}`;
        };

        /** 4️⃣ Determine Display Price **/
        let displayPrice =
          bookingDetails.priceRange ||
          "£13.50hr (with cleaning supplies provided)";
        if (displayPrice === "£0.00" && getParam("amount")) {
          displayPrice = `£${(parseFloat(getParam("amount")) / 100).toFixed(
            2
          )}`;
        }

        /** 5️⃣ Build the HTML to insert **/
        // Build service details based on form type
        let serviceDetailsHTML = "";

        // Common service details
        serviceDetailsHTML += `
    <div class="section-header">Service Information</div>
    <div class="detail-item">
      <div class="detail-label">Service Type:</div>
      <div class="detail-value">${bookingDetails.serviceType} ${
          bookingDetails.formType === "basic"
            ? "(Basic Cleaning)"
            : bookingDetails.formType === "deep"
            ? "(Deep Cleaning)"
            : ""
        }</div>
    </div>`;

        // Add bedrooms and frequency for basic/deep cleaning forms
        if (bookingDetails.formType !== "oneoff") {
          serviceDetailsHTML += `
    <div class="detail-item">
      <div class="detail-label">Cleaning Frequency:</div>
      <div class="detail-value">${
        formatFrequency(bookingDetails.frequency) || "N/A"
      }</div>
    </div>`;
        }

        // Add house size if available
        if (bookingDetails.houseSize && bookingDetails.houseSize !== "N/A") {
          serviceDetailsHTML += `
    <div class="detail-item">
      <div class="detail-label">House Size:</div>
      <div class="detail-value">${bookingDetails.houseSize}</div>
    </div>`;
        }

        // Add service schedule
        serviceDetailsHTML += `
    <div class="detail-item">
      <div class="detail-label">Preferred Date & Time:</div>
      <div class="detail-value">${formatDate(
        bookingDetails.preferredDate
      )} & ${formatTime(bookingDetails.preferredTime)}</div>
    </div>`;

        // Customer information - using let instead of const to allow modifications
        let customerDetailsHTML = `
  <div class="section-header" style="font-weight: bold; margin-bottom: 10px;">Customer Information</div>

  <div class="detail-feilds" style="display: flex; gap: 20px; margin-bottom: 5px;">
    <div class="detail-feilds-row" style="flex: 1; display: flex;">
      <div style="width: 100px; font-weight: bold;">Name:</div>
      <div class="detail-value">${bookingDetails.fullName || "N/A"}</div>
    </div>
    <div  class="detail-feilds-row" style="flex: 1; display: flex;">
      <div style="width: 100px; font-weight: bold;">Email:</div>
      <div class="detail-value">${bookingDetails.email || "N/A"}</div>
    </div>
  </div>

  <div class="detail-feilds" style="display: flex; gap: 20px; margin-bottom: 5px;">
    <div class="detail-feilds-row" style="flex: 1; display: flex;">
      <div style="width: 100px; font-weight: bold;">Phone:</div>
      <div class="detail-value">${bookingDetails.phone || "N/A"}</div>
    </div>
    <div class="detail-feilds-row" style="flex: 1; display: flex;">
      <div style="width: 100px; font-weight: bold;">Alt Phone:</div>
      <div class="detail-value">${bookingDetails.alternatePhone || "N/A"}</div>
    </div>
  </div>
`;

        // Service address
        const addressHTML = `
  <div class="section-header" style="font-weight: bold; margin-bottom: 10px;">Service Address</div>

  <!-- Address stays on its own line -->
  <div class="detail-feilds-row" style="display: flex; margin-bottom: 5px;">
    <div style="width: 100px; font-weight: bold;">Address:</div>
    <div class="detail-value">${bookingDetails.address || "N/A"}</div>
  </div>

  <!-- City, Postcode, Country in one line -->
  <div class="detail-feilds" style="display: flex; gap: 20px; margin-bottom: 5px;">
    <div class="detail-feilds-row" style="flex: 1; display: flex;">
      <div style="width: 91px; font-weight: bold;">City:</div>
      <div class="detail-value">${bookingDetails.city || "N/A"}</div>
    </div>
    <div class="detail-feilds-row" style="flex: 1; display: flex;">
      <div style="width: 100px; font-weight: bold;">Postcode:</div>
      <div class="detail-value">${bookingDetails.postcode || "N/A"}</div>
    </div>
    <div class="detail-feilds-row" style="flex: 1; display: flex;">
      <div style="width: 100px; font-weight: bold;">Country:</div>
      <div class="detail-value">${bookingDetails.country || "N/A"}</div>
    </div>
  </div>
`;

        // Special instructions if available
        let notesHTML = "";
        if (bookingDetails.notes && bookingDetails.notes !== "N/A") {
          notesHTML = `
    <div class="section-header">Special Instructions</div>
    <div class="detail-item">
      <div class="detail-value">${bookingDetails.notes}</div>
    </div>`;
        }

        // Payment information
        const paymentHTML = `
    <div class="section-header">Payment Information</div>
    <div class="detail-feilds" style="display: flex; gap: 20px; margin-bottom: 5px;">
      <div class="detail-feilds-row" style="flex: 1; display: flex;">
        <div style="width: 150px; font-weight: bold;">Total Amount:</div>
        <div class="detail-value">${displayPrice}</div>
      </div>
      <div class="detail-feilds-row" style="flex: 1; display: flex;">
        <div style="width: 150px; font-weight: bold;">Payment Status:</div>
        <div class="detail-value" class="text-success">${bookingDetails.paymentStatus}</div>
      </div>
    </div>`;

        // Combine all sections
        const detailsHTML =
          serviceDetailsHTML +
          customerDetailsHTML +
          addressHTML +
          notesHTML +
          paymentHTML;

        /** 6️⃣ Inject the HTML into the page **/
        document.getElementById("bookingDetails").innerHTML = detailsHTML;

        /** 7️⃣ WhatsApp Link **/
        const whatsappBtn = document.getElementById("whatsappBtn");
        if (whatsappBtn) {
          const message = encodeURIComponent(
            `*New Booking*
*Service Type:* ${bookingDetails.serviceType}
*House Size:* ${bookingDetails.houseSize}
*Preferred Date:* ${formatDate(bookingDetails.preferredDate)}
*Preferred Time:* ${formatTime(bookingDetails.preferredTime)}
*Amount Paid:* ${displayPrice}

*Customer Details*
Name: ${bookingDetails.fullName}
Email: ${bookingDetails.email}
Phone: ${bookingDetails.phone}
Alternate Phone: ${bookingDetails.alternatePhone}

*Address*
${bookingDetails.address}
${bookingDetails.city}, ${bookingDetails.postcode}
${bookingDetails.country}

Thank you for booking with Well Clean!`
          );
          whatsappBtn.href = `https://wa.me/+447398538498?text=${message}`;
        }
      });
    </script>
    <script>
      document
        .getElementById("downloadBtn")
        .addEventListener("click", function () {
          const receiptContent = document.querySelector(".success-container");

          // Clone content and remove buttons
          const clone = receiptContent.cloneNode(true);
          const buttons = clone.querySelectorAll(
            ".btn, .btn-download, .btn-back, .btn-whatsapp"
          );
          buttons.forEach((btn) => btn.remove());

          // Create a temporary offscreen container
          const tempDiv = document.createElement("div");
          tempDiv.style.position = "fixed";
          tempDiv.style.left = "-9999px";
          tempDiv.style.top = "0";
          tempDiv.style.width = "800px";
          tempDiv.style.background = "#fff";
          tempDiv.appendChild(clone);
          document.body.appendChild(tempDiv);

          // 🔹 Find "Name:" label more flexibly
          let nameValue = "receipt";
          const nameLabel = Array.from(clone.querySelectorAll("div")).find(
            (div) => div.textContent.trim() === "Name:"
          );

          if (nameLabel) {
            const val = nameLabel.nextElementSibling?.textContent?.trim();
            if (val) nameValue = val;
          }

          const safeName = nameValue.split(" ")[0] || "receipt";

          // Capture the cleaned content
          html2canvas(clone, {
            scale: 3,
            useCORS: true,
            backgroundColor: "#ffffff",
          }).then((canvas) => {
            const imgData = canvas.toDataURL("image/png");

            // Trigger download
            const link = document.createElement("a");
            link.href = imgData;
            link.download = `${safeName}-receipt.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Cleanup
            document.body.removeChild(tempDiv);
          });
        });
    </script>

    <script>
      function updateNavbarVisibility() {
        const navbarCollapse = document.getElementById("navbarCollapse");
        if (navbarCollapse) {
          if (window.innerWidth > 991.98) {
            navbarCollapse.classList.add("show");
          } else {
            navbarCollapse.classList.remove("show");
          }
        }
      }

      updateNavbarVisibility();

      const navbarToggler = document.querySelector(".navbar-toggler");
      if (navbarToggler) {
        navbarToggler.addEventListener("click", function () {
          const navbarCollapse = document.getElementById("navbarCollapse");
          if (window.innerWidth <= 991.98 && navbarCollapse) {
            navbarCollapse.classList.toggle("show");
          }
        });
      }
      window.addEventListener("resize", updateNavbarVisibility);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
