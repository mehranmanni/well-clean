<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Successful - Well Clean</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="img/favicon-32x32.png" />

    <style>
      body {
        background-color: #f8f9fa;
        font-family: "Varela Round", sans-serif;
      }
      .success-container {
        max-width: 800px;
        margin: 50px auto;
        padding: 40px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }
      .success-icon {
        font-size: 60px;
        color: #28a745;
        margin-bottom: 20px;
        text-align: center;
      }
      .btn-whatsapp {
        background-color: #25d366;
        color: white;
        padding: 12px 25px;
        border-radius: 30px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        margin: 10px 5px;
        transition: all 0.3s;
        border: none;
      }
      .btn-whatsapp:hover {
        background-color: #128c7e;
        color: white;
        transform: translateY(-2px);
      }
      .btn-back {
        background-color: #6c757d;
        color: white;
        padding: 12px 25px;
        border-radius: 30px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        margin: 10px 5px;
        transition: all 0.3s;
      }
      .btn-back:hover {
        background-color: #5a6268;
        color: white;
        transform: translateY(-2px);
      }
      .btn-download {
        background-color: #0d6efd;
        color: white;
        padding: 12px 25px;
        border-radius: 30px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        margin: 10px 5px;
        transition: all 0.3s;
        border: none;
      }
      .btn-download:hover {
        background-color: #0b5ed7;
        color: white;
        transform: translateY(-2px);
      }
      .btn-download i {
        margin-right: 8px;
      }
      .booking-details {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 30px 0;
      }
      .detail-item {
        display: flex;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .detail-label {
        font-weight: 600;
        width: 200px;
        color: #495057;
      }
      .detail-value {
        flex: 1;
        color: #212529;
      }
      .payment-confirmed {
        font-size: 1.1em;
        font-weight: 600;
        color: #28a745;
        margin: 20px 0;
        text-align: center;
        padding: 10px;
        background-color: #e8f5e9;
        border-radius: 5px;
      }
      .capturing {
        opacity: 0.5;
      }
      #receiptContainer {
        position: fixed;
        left: -9999px;
        top: -9999px;
        width: 800px;
        background: white;
        padding: 40px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }
      .receipt-buttons {
        display: none !important;
      }
      .section-header {
        font-weight: bold;
        font-size: 1.1em;
        color: #2c3e50;
        margin-top: 20px;
        padding-bottom: 5px;
        border-bottom: 2px solid #3498db;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .detail-item {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
      }
      .detail-label {
        font-weight: 600;
        color: #555;
        margin-bottom: 4px;
      }
      .detail-value {
        color: #2c3e50;
      }
      .full-width {
        grid-column: 1 / -1;
      }
      .booking-details-container {
        padding: 20px;
        border-radius: 10px;
        background-color: #f8f9fa;
      }
    </style>
  </head>
  <body>
    <!-- Hidden receipt container -->
    <div id="receiptContainer"></div>

    <div class="container">
      <div class="success-container">
        <div class="text-center mb-4">
          <div class="d-flex justify-content-center align-items-center mb-3">
            <img
              src="img/testing-logo-2.png"
              alt="Well Clean Logo"
              class="img-fluid me-3"
              style="max-height: 70px"
            />
          </div>
          <div class="d-flex justify-content-center">
            <h2 class="mb-3 d-flex align-items-center gap-2">
              Payment Successful!
              <div class="success-icon" style="font-size: 40px; margin: 0">
                <i class="fas fa-check-circle"></i>
              </div>
            </h2>
          </div>

          <p class="lead">Thank you for booking with Well Clean.</p>
        </div>
        <div class="payment-confirmed">
          <i class="fas fa-check-circle me-2"></i> Payment Confirmed
        </div>

        <div class="booking-details-container">
          <div id="bookingDetails">
            <!-- Details will be populated by JavaScript -->
          </div>
        </div>

        <div class="text-center">
          <p class="mb-4">
            Our team will contact you shortly to confirm your cleaning
            appointment details. <br />
            For any questions, feel free to reach out to us on WhatsApp.
          </p>

          <div class="d-flex justify-content-center flex-wrap">
            <a href="/" class="btn-back">
              <i class="fas fa-home me-2"></i>Back to Home
            </a>
            <a href="#" id="whatsappBtn" class="btn-whatsapp">
              <i class="fab fa-whatsapp me-2"></i>Chat on WhatsApp
            </a>
            <a href="#" id="downloadBtn" class="btn-download">
              <i class="fas fa-download me-2"></i>Download Receipt
            </a>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
      // Get booking details from URL parameters
      function getBookingDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const details = {};

        // Common fields
        details.serviceType = urlParams.get("serviceType") || "N/A";
        details.houseSize = urlParams.get("houseSize") || "N/A";
        details.roomSize = urlParams.get("roomSize") || "N/A";
        details.totalPrice = urlParams.get("totalPrice") || "£0.00";
        details.name = urlParams.get("name") || "N/A";
        details.email = urlParams.get("email") || "N/A";
        details.phone = urlParams.get("phone") || "N/A";
        details.alternatePhone = urlParams.get("alternatePhone") || "N/A";
        details.address = urlParams.get("address") || "N/A";
        details.city = urlParams.get("city") || "N/A";
        details.postcode = urlParams.get("postcode") || "N/A";
        details.country = urlParams.get("country") || "N/A";
        details.notes = urlParams.get("notes") || "N/A";
        details.specialInstructions =
          urlParams.get("specialInstructions") || "N/A";

        // One-off cleaning specific fields
        if (details.serviceType === "One-Off Cleaning") {
          details.date = urlParams.get("oneOffDate") || "N/A";
          details.time = urlParams.get("oneOffTime") || "N/A";
          details.preferredTime = urlParams.get("preferredTime") || "N/A";
        }

        // Regular cleaning specific fields
        if (details.serviceType === "Regular Cleaning") {
          details.frequency = urlParams.get("frequency") || "N/A";
          details.serviceDate = urlParams.get("serviceDate") || "N/A";
          details.serviceTime = urlParams.get("serviceTime") || "N/A";
        }

        return details;
      }

      // Format booking details for display
      function formatBookingDetails(details) {
        if (!details) return "";

        // Format date for display
        let formattedDate = "N/A";
        if (details.date || details.serviceDate) {
          const date = details.date || details.serviceDate;
          const dateObj = new Date(date);
          if (!isNaN(dateObj)) {
            formattedDate = dateObj.toLocaleDateString("en-GB", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
          } else {
            formattedDate = date;
          }
        }

        // Format time for display
        let formattedTime = "N/A";
        if (details.time || details.serviceTime) {
          const time = details.time || details.serviceTime;
          const timeMatch = time.match(/^([0-9]{1,2}):?([0-9]{2})?/);
          if (timeMatch) {
            let hours = parseInt(timeMatch[1]);
            const minutes = timeMatch[2] ? ":" + timeMatch[2] : "";
            const ampm = hours >= 12 ? "PM" : "AM";
            hours = hours % 12;
            hours = hours ? hours : 12;
            formattedTime = hours + minutes + " " + ampm;
          } else {
            formattedTime = time;
          }
        }

        // Determine cleaning type and format accordingly
        const isRegular = details.serviceType === "Regular Cleaning";

        // Service Information Section
        let serviceInfo = `
          <div class="section-header">Service Information</div>
          <div class="detail-item">
            <div class="detail-label">Service Type:</div>
            <div class="detail-value">${details.serviceType || "N/A"}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">House Size:</div>
            <div class="detail-value">${
              details.roomSize || details.houseSize || "N/A"
            }</div>
          </div>
        `;

        // Add frequency only for regular cleaning
        if (isRegular) {
          serviceInfo += `
            <div class="detail-item">
              <div class="detail-label">Cleaning Frequency:</div>
              <div class="detail-value">${details.frequency || "N/A"}</div>
            </div>
          `;
        }

        // Add date and time
        serviceInfo += `
          <div class="detail-item">
            <div class="detail-label">Scheduled Date:</div>
            <div class="detail-value">${formattedDate}</div>
          </div>
          
        `;

        // Customer Information Section
        const customerInfo = `
          <div class="section-header mt-4">Customer Information</div>
          <div class="detail-item">
            <div class="detail-label">Name:</div>
            <div class="detail-value">${details.name || "N/A"}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Email:</div>
            <div class="detail-value">${details.email || "N/A"}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Phone:</div>
            <div class="detail-value">${details.phone || "N/A"}</div>
          </div>
          ${
            details.alternatePhone
              ? `
          <div class="detail-item">
            <div class="detail-label">Alternative Phone:</div>
            <div class="detail-value">${details.alternatePhone || "N/A"}</div>
          </div>
          `
              : ""
          }
        `;

        // Service Address Section
        const addressInfo = `
          <div class="section-header mt-4">Service Address</div>
          <div class="detail-item">
            <div class="detail-label">Address:</div>
            <div class="detail-value">${details.address || "N/A"}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">City:</div>
            <div class="detail-value">${details.city || "N/A"}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Postcode:</div>
            <div class="detail-value">${details.postcode || "N/A"}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Country:</div>
            <div class="detail-value">${details.country || "N/A"}</div>
          </div>
        `;

        // Special Instructions Section
        const instructions = `
          ${
            details.notes || details.specialInstructions
              ? `
          <div class="section-header mt-4">Special Instructions</div>
          <div class="detail-item">
            <div class="detail-value">${
              details.notes || details.specialInstructions || "None"
            }</div>
          </div>
          `
              : ""
          }
        `;

        // Payment Information Section
        const paymentInfo = `
          <div class="section-header mt-4">Payment Information</div>
          <div class="detail-item">
            <div class="detail-label">Total Amount:</div>
            <div class="detail-value fw-bold">${
              details.totalPrice || "£0.00"
            }</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Payment Status:</div>
            <div class="detail-value text-success fw-bold">
              <i class="fas fa-check-circle me-2"></i>Paid
            </div>
          </div>
        `;

        return `
          <div class="booking-details-container">
            ${serviceInfo}
            ${customerInfo}
            ${addressInfo}
            ${instructions}
            ${paymentInfo}
          </div>
        `;
      }

      // Generate WhatsApp message
      function generateWhatsAppMessage(details) {
        if (!details) return "";

        const isRegular = details.serviceType === "Regular Cleaning";

        let message = `*New Booking*

*Service Information*
Service Type: ${details.serviceType || "N/A"}
House Size: ${details.roomSize || details.houseSize || "N/A"}
${isRegular ? `Frequency: ${details.frequency || "N/A"}\n` : ""}
Amount Paid: ${details.totalPrice || "N/A"}

*Customer Details*
Name: ${details.name || details.customerName || "N/A"}
Email: ${details.email || details.customerEmail || "N/A"}
Phone: ${details.phone || details.customerPhone || "N/A"}
${
  details.alternatePhone ? `Alternative Phone: ${details.alternatePhone}\n` : ""
}

*Service Schedule*
${
  details.date || details.serviceDate
    ? `Date: ${details.date || details.serviceDate}\n`
    : ""
}
${
  details.time || details.serviceTime
    ? `Time: ${details.time || details.serviceTime}\n`
    : ""
}

*Service Address*
Address: ${details.address || "N/A"}
City: ${details.city || "N/A"}
Postcode: ${details.postcode || "N/A"}
Country: ${details.country || "N/A"}

${
  details.notes || details.specialInstructions
    ? `*Special Instructions*
${details.notes || details.specialInstructions}

`
    : ""
}

*Payment Status*
Paid Successfully

Thank you for booking with Well Clean!`;

        return message;
      }

      // Function to create receipt content
      function createReceiptContent() {
        const bookingData = JSON.parse(sessionStorage.getItem("receiptData"));
        const container = document.getElementById("receiptContainer");

        // Create receipt HTML
        container.innerHTML = `
          <div class="success-container">
            <div class="text-center mb-4">
              <div class="d-flex justify-content-center align-items-center mb-3">
                <img src="img/testing-logo-2.png" alt="Well Clean Logo" class="img-fluid me-3" style="max-height: 60px">
                <div class="success-icon" style="font-size: 40px; margin: 0; color: #28a745;">
                  <i class="fas fa-check-circle"></i>
                </div>
              </div>
              <h2 class="mb-3">Payment Successful!</h2>
              <p class="lead">Thank you for booking with Well Clean.</p>
            </div>
            <div class="payment-confirmed">
              <i class="fas fa-check-circle me-2"></i> Payment Confirmed
            </div>
            <div class="booking-details-container">
              <div id="receiptDetails"></div>
            </div>
          </div>
        `;

        // Format and add booking details
        const receiptDetails = document.getElementById("receiptDetails");
        const formattedDetails = formatBookingDetails(bookingData);

        if (formattedDetails.length > 0) {
          receiptDetails.innerHTML = formattedDetails;
        }

        return container;
      }

      // Function to capture and download div as PNG
      async function downloadReceipt() {
        try {
          const receiptElement = createReceiptContent();

          // Wait for images to load
          const images = receiptElement.getElementsByTagName("img");
          await Promise.all(
            Array.from(images).map((img) => {
              if (img.complete) return Promise.resolve();
              return new Promise((resolve) => {
                img.onload = resolve;
                img.onerror = resolve; // Continue even if image fails to load
              });
            })
          );

          // Capture with higher quality settings
          const canvas = await html2canvas(receiptElement, {
            scale: 3, // Increased scale for better quality
            logging: false,
            useCORS: true,
            allowTaint: true,
            backgroundColor: "#ffffff",
            scrollX: 0,
            scrollY: 0,
            windowWidth: document.documentElement.offsetWidth,
            windowHeight: document.documentElement.offsetHeight,
          });

          // Create and trigger download
          const link = document.createElement("a");
          link.download = `WellClean_Receipt_${
            getBookingDetails().bookingId || "new"
          }_${new Date().toISOString().slice(0, 10)}.png`;
          link.href = canvas.toDataURL("image/png", 1.0); // Maximum quality
          link.click();
        } catch (error) {
          console.error("Error generating receipt:", error);
          alert("Error generating receipt. Please try again.");
        }
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        // First try to get booking details from sessionStorage
        const bookingData = JSON.parse(sessionStorage.getItem("bookingData"));

        if (bookingData) {
          // If we have data in sessionStorage, use it
          const detailsContainer = document.getElementById("bookingDetails");
          detailsContainer.innerHTML = formatBookingDetails(bookingData);

          // Update WhatsApp button with the booking details
          const whatsappBtn = document.getElementById("whatsappBtn");
          if (whatsappBtn) {
            const whatsappMessage = generateWhatsAppMessage(bookingData);
            whatsappBtn.href = `https://wa.me/447507460808?text=${encodeURIComponent(
              whatsappMessage
            )}`;
          }

          // Store the booking data in sessionStorage for receipt generation
          sessionStorage.setItem("receiptData", JSON.stringify(bookingData));

          // Clear the booking data from sessionStorage after use
          sessionStorage.removeItem("bookingData");
        } else {
          // Fallback to URL parameters if no session data
          const bookingDetails = getBookingDetails();
          const detailsContainer = document.getElementById("bookingDetails");
          if (bookingDetails) {
            detailsContainer.innerHTML = formatBookingDetails(bookingDetails);
          }
        }
      });

      // Add event listener for download button
      document.addEventListener("DOMContentLoaded", function () {
        const downloadBtn = document.getElementById("downloadBtn");
        if (downloadBtn) {
          downloadBtn.addEventListener("click", function (e) {
            e.preventDefault();
            downloadReceipt();
          });
        }
      });
    </script>
  </body>
</html>
